<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×“×©×‘×•×¨×“ ×¤×™× × ×¡×™ ×—×›×</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9fafb;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // Initialize Supabase
        const supabaseUrl = 'https://qjfkmfemxipaeslfwyld.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqZmttZmVteGlwYWVzbGZ3eWxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MTU3MzEsImV4cCI6MjA2NzE5MTczMX0.c-RIt6dWm4RPx6xV71RQM13fkEveIARFt4XVRPUovPY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        // Simple icon component using text symbols (no external dependencies)
        const Icon = ({ name, className = "h-4 w-4" }) => {
          const iconMap = {
            'filter': 'âš™',
            'dollar-sign': 'â‚ª',
            'receipt': 'ğŸ“„',
            'trending-up': 'ğŸ“ˆ',
            'check-circle': 'âœ“',
            'alert-circle': 'âš ',
            'search': 'ğŸ”',
            'upload': 'â†‘',
            'download': 'â†“',
            'plus': '+',
            'edit-2': 'âœ',
            'trash-2': 'ğŸ—‘',
            'save': 'ğŸ’¾',
            'x': 'âœ•',
            'database': 'ğŸ“Š'
          };
          
          const symbol = iconMap[name] || 'â€¢';
          
          return React.createElement('span', { 
            className: className,
            style: { 
              display: 'inline-flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '0.875rem',
              fontFamily: 'system-ui, -apple-system, sans-serif'
            }
          }, symbol);
        };

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
          constructor(props) {
            super(props);
            this.state = { hasError: false };
          }

          static getDerivedStateFromError(error) {
            return { hasError: true };
          }

          componentDidCatch(error, errorInfo) {
            console.warn('React Error Boundary caught error:', error, errorInfo);
          }

          render() {
            if (this.state.hasError) {
              return React.createElement('div', { 
                className: "p-4 text-center text-red-600" 
              }, 'Something went wrong. Please refresh the page.');
            }

            return this.props.children;
          }
        }

        // Authentication Component
        const AuthComponent = () => {
          const [isLogin, setIsLogin] = useState(true);
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [fullName, setFullName] = useState('');
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');

          const handleAuth = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError('');

            try {
              if (isLogin) {
                const { data, error } = await supabase.auth.signInWithPassword({
                  email,
                  password,
                });
                if (error) throw error;
              } else {
                const { data, error } = await supabase.auth.signUp({
                  email,
                  password,
                  options: {
                    data: {
                      full_name: fullName,
                    }
                  }
                });
                if (error) throw error;
                if (data.user && !data.session) {
                  setError('×× × ×‘×“×•×§ ××ª ×”××™××™×™×œ ×©×œ×š ×œ×§×™×©×•×¨ ×”××™××•×ª');
                }
              }
            } catch (error) {
              setError(error.message);
            } finally {
              setLoading(false);
            }
          };

          return React.createElement('div', {
            className: "min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4"
          }, [
            React.createElement('div', {
              className: "max-w-md w-full bg-white rounded-xl shadow-lg p-8",
              key: "auth-container"
            }, [
              React.createElement('div', {
                className: "text-center mb-8",
                key: "header"
              }, [
                React.createElement('h1', {
                  className: "text-3xl font-bold text-gray-900 mb-2",
                  key: "title"
                }, '×“×©×‘×•×¨×“ ×¤×™× × ×¡×™ ×—×›×'),
                React.createElement('p', {
                  className: "text-gray-600",
                  key: "subtitle"
                }, isLogin ? '×”×ª×—×‘×¨ ×œ×—×©×‘×•×Ÿ ×©×œ×š' : '×¦×•×¨ ×—×©×‘×•×Ÿ ×—×“×©')
              ]),
              
              React.createElement('form', {
                onSubmit: handleAuth,
                className: "space-y-6",
                key: "form"
              }, [
                !isLogin && React.createElement('div', {
                  key: "fullname-field"
                }, [
                  React.createElement('label', {
                    className: "block text-sm font-medium text-gray-700 mb-2",
                    key: "fullname-label"
                  }, '×©× ××œ×'),
                  React.createElement('input', {
                    type: "text",
                    value: fullName,
                    onChange: (e) => setFullName(e.target.value),
                    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                    required: true,
                    key: "fullname-input"
                  })
                ]),
                
                React.createElement('div', {
                  key: "email-field"
                }, [
                  React.createElement('label', {
                    className: "block text-sm font-medium text-gray-700 mb-2",
                    key: "email-label"
                  }, '×›×ª×•×‘×ª ××™××™×™×œ'),
                  React.createElement('input', {
                    type: "email",
                    value: email,
                    onChange: (e) => setEmail(e.target.value),
                    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                    required: true,
                    key: "email-input"
                  })
                ]),
                
                React.createElement('div', {
                  key: "password-field"
                }, [
                  React.createElement('label', {
                    className: "block text-sm font-medium text-gray-700 mb-2",
                    key: "password-label"
                  }, '×¡×™×¡××”'),
                  React.createElement('input', {
                    type: "password",
                    value: password,
                    onChange: (e) => setPassword(e.target.value),
                    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                    required: true,
                    minLength: 6,
                    key: "password-input"
                  })
                ]),
                
                error && React.createElement('div', {
                  className: "text-red-600 text-sm text-center",
                  key: "error"
                }, error),
                
                React.createElement('button', {
                  type: "submit",
                  disabled: loading,
                  className: `w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white font-medium rounded-lg transition-colors ${loading ? 'cursor-not-allowed' : ''}`,
                  key: "submit-button"
                }, loading ? '××ª×—×‘×¨...' : (isLogin ? '×”×ª×—×‘×¨' : '×¦×•×¨ ×—×©×‘×•×Ÿ')),
                
                React.createElement('div', {
                  className: "text-center",
                  key: "toggle"
                }, [
                  React.createElement('button', {
                    type: "button",
                    onClick: () => {
                      setIsLogin(!isLogin);
                      setError('');
                    },
                    className: "text-blue-600 hover:text-blue-800 font-medium",
                    key: "toggle-button"
                  }, isLogin ? '×¢×“×™×™×Ÿ ××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×¦×•×¨ ×—×©×‘×•×Ÿ' : '×›×‘×¨ ×™×© ×œ×š ×—×©×‘×•×Ÿ? ×”×ª×—×‘×¨')
                ])
              ])
            ])
          ]);
        };

        // Main App Component with Authentication
        const App = () => {
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            // Get initial session
            supabase.auth.getSession().then(({ data: { session } }) => {
              setUser(session?.user ?? null);
              setLoading(false);
            });

            // Listen for auth changes
            const { data: { subscription } } = supabase.auth.onAuthStateChange(
              async (event, session) => {
                setUser(session?.user ?? null);
                setLoading(false);
              }
            );

            return () => subscription.unsubscribe();
          }, []);

          if (loading) {
            return React.createElement('div', {
              className: "min-h-screen bg-gray-50 flex items-center justify-center"
            }, [
              React.createElement('div', {
                className: "text-center",
                key: "loading"
              }, [
                React.createElement('div', {
                  className: "animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4",
                  key: "spinner"
                }),
                React.createElement('p', {
                  className: "text-gray-600",
                  key: "loading-text"
                }, '×˜×•×¢×Ÿ...')
              ])
            ]);
          }

          if (!user) {
            return React.createElement(AuthComponent);
          }

          return React.createElement(FinancialDashboard, { user });
        };

        const FinancialDashboard = ({ user }) => {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [currentWorkspace, setCurrentWorkspace] = useState(null);
          const [workspaces, setWorkspaces] = useState([]);
          const [isOnline, setIsOnline] = useState(navigator.onLine);
          
          // Always start with empty array - no automatic persistence
          const [projects, setProjects] = useState([]);

          const [selectedProject, setSelectedProject] = useState('all');
          const [isEditing, setIsEditing] = useState(null);
          const [newProject, setNewProject] = useState({
            orderDate: '',
            clientName: '',
            orderDetails: '',
            transactionAmount: '',
            vatPercent: 17,
            projectReceipts: '',
            projectNotes: '',
            invoiceIssued: false,
            activationDate: ''
          });
          const [showAddForm, setShowAddForm] = useState(false);
          const [searchTerm, setSearchTerm] = useState('');
          const [isImporting, setIsImporting] = useState(false);
          const [importError, setImportError] = useState('');
          const [showNewWorkspaceForm, setShowNewWorkspaceForm] = useState(false);
          const [newWorkspaceName, setNewWorkspaceName] = useState('');
          
          // File input ref for import
          const fileInputRef = React.useRef(null);

          // ×—×™×©×•×‘ KPI
          const dashboardData = useMemo(() => {
            const filteredProjects = selectedProject === 'all' 
              ? projects 
              : projects.filter(p => p.id === parseInt(selectedProject));

            const totalTransactionAmount = filteredProjects.reduce((sum, p) => sum + p.transactionAmount, 0);
            const totalVatAmount = filteredProjects.reduce((sum, p) => sum + (p.transactionAmount * p.vatPercent / 100), 0);
            const totalPayment = filteredProjects.reduce((sum, p) => sum + p.totalPayment, 0);
            const totalReceipts = filteredProjects.reduce((sum, p) => sum + p.projectReceipts, 0);
            const totalRemaining = filteredProjects.reduce((sum, p) => sum + p.remainingBalance, 0);

            const completionRate = totalPayment > 0 ? (totalReceipts / totalPayment) * 100 : 0;
            const completedProjects = filteredProjects.filter(p => p.remainingBalance === 0).length;
            const inProgressProjects = filteredProjects.filter(p => p.remainingBalance > 0).length;
            
            // Invoice statistics
            const invoicedProjects = filteredProjects.filter(p => p.invoiceIssued === true).length;
            const uninvoicedProjects = filteredProjects.filter(p => p.invoiceIssued === false).length;
            const invoiceRate = filteredProjects.length > 0 ? (invoicedProjects / filteredProjects.length) * 100 : 0;
            
            // Activation date statistics
            const projectsWithActivation = filteredProjects.filter(p => p.activationDate && p.activationDate.trim() !== '').length;
            const activationRate = filteredProjects.length > 0 ? (projectsWithActivation / filteredProjects.length) * 100 : 0;
            
            // Find latest activation date for display
            const activationDates = filteredProjects
              .filter(p => p.activationDate && p.activationDate.trim() !== '')
              .map(p => new Date(p.activationDate))
              .sort((a, b) => b - a);
            const latestActivationDate = activationDates.length > 0 ? activationDates[0] : null;

            return {
              totalTransactionAmount,
              totalVatAmount,
              totalPayment,
              totalReceipts,
              totalRemaining,
              completionRate,
              completedProjects,
              inProgressProjects,
              totalProjects: filteredProjects.length,
              invoicedProjects,
              uninvoicedProjects,
              invoiceRate,
              projectsWithActivation,
              activationRate,
              latestActivationDate
            };
          }, [projects, selectedProject]);

          // Workspace management functions
          const loadWorkspaceData = async (workspaceId) => {
            try {
              const { data, error } = await supabase
                .from('projects')
                .select('*')
                .eq('workspace_id', workspaceId)
                .order('created_at', { ascending: false });

              if (error) throw error;
              
              // Convert database format to application format
              const projectsData = data.map(project => ({
                id: project.id,
                orderDate: project.order_date,
                clientName: project.client_name,
                orderDetails: project.order_details,
                transactionAmount: parseFloat(project.transaction_amount),
                vatPercent: parseFloat(project.vat_percent),
                totalPayment: parseFloat(project.total_payment),
                projectReceipts: parseFloat(project.project_receipts),
                remainingBalance: parseFloat(project.remaining_balance),
                projectNotes: project.project_notes || '',
                invoiceIssued: project.invoice_issued,
                activationDate: project.activation_date
              }));
              
              setProjects(projectsData);
            } catch (error) {
              console.error('Error loading workspace data:', error);
              setProjects([]);
            }
          };

          const saveWorkspaceData = async (workspaceId, projectsData) => {
            if (!workspaceId || !Array.isArray(projectsData)) return;
            
            try {
              // Delete existing projects for this workspace
              const { error: deleteError } = await supabase
                .from('projects')
                .delete()
                .eq('workspace_id', workspaceId);

              if (deleteError) throw deleteError;

              // Insert new projects if any exist
              if (projectsData.length > 0) {
                const projectsToInsert = projectsData.map(project => ({
                  id: project.id,
                  workspace_id: workspaceId,
                  order_date: project.orderDate,
                  client_name: project.clientName,
                  order_details: project.orderDetails,
                  transaction_amount: project.transactionAmount,
                  vat_percent: project.vatPercent,
                  total_payment: project.totalPayment,
                  project_receipts: project.projectReceipts,
                  remaining_balance: project.remainingBalance,
                  project_notes: project.projectNotes || '',
                  invoice_issued: project.invoiceIssued,
                  activation_date: project.activationDate
                }));

                const { error: insertError } = await supabase
                  .from('projects')
                  .insert(projectsToInsert);

                if (insertError) throw insertError;
              }
            } catch (error) {
              console.error('Error saving workspace data:', error);
            }
          };

          const switchWorkspace = async (workspaceId) => {
            try {
              // Save current workspace data before switching
              if (currentWorkspace) {
                await saveWorkspaceData(currentWorkspace, projects);
              }
              
              setCurrentWorkspace(workspaceId);
              await loadWorkspaceData(workspaceId);
            } catch (error) {
              console.error('Error switching workspace:', error);
            }
          };

          const loadUserWorkspaces = async () => {
            try {
              // First get workspace IDs for this user
              const { data: userWorkspaces, error: userError } = await supabase
                .from('workspace_users')
                .select('workspace_id, role')
                .eq('user_id', user.id);

              if (userError) throw userError;

              if (!userWorkspaces || userWorkspaces.length === 0) {
                // No workspaces found, will trigger auto-creation
                setWorkspaces([]);
                return;
              }

              // Get workspace details
              const workspaceIds = userWorkspaces.map(uw => uw.workspace_id);
              const { data: workspacesData, error: workspacesError } = await supabase
                .from('workspaces')
                .select('id, name, created_at')
                .in('id', workspaceIds)
                .order('created_at', { ascending: false });

              if (workspacesError) throw workspacesError;

              const formattedWorkspaces = workspacesData.map(workspace => ({
                id: workspace.id,
                name: workspace.name
              }));

              setWorkspaces(formattedWorkspaces);
              
              // Set first workspace as current if none selected
              if (formattedWorkspaces.length > 0 && !currentWorkspace) {
                const firstWorkspace = formattedWorkspaces[0];
                setCurrentWorkspace(firstWorkspace.id);
                await loadWorkspaceData(firstWorkspace.id);
              } else if (formattedWorkspaces.length === 0) {
                // Create a default workspace for new users
                try {
                  const { data: workspaceData, error: workspaceError } = await supabase
                    .from('workspaces')
                    .insert([
                      {
                        name: '××¨×—×‘ ×¢×‘×•×“×” ×¨××©×™',
                        created_by: user.id
                      }
                    ])
                    .select()
                    .single();

                  if (workspaceError) throw workspaceError;

                  // Add the creator to workspace_users (use upsert to avoid duplicates)
                  const { error: userError } = await supabase
                    .from('workspace_users')
                    .upsert([
                      {
                        workspace_id: workspaceData.id,
                        user_id: user.id,
                        role: 'owner'
                      }
                    ], {
                      onConflict: 'workspace_id,user_id'
                    });

                  if (userError) throw userError;

                  const defaultWorkspace = {
                    id: workspaceData.id,
                    name: workspaceData.name
                  };
                  
                  setWorkspaces([defaultWorkspace]);
                  setCurrentWorkspace(workspaceData.id);
                  await loadWorkspaceData(workspaceData.id);
                } catch (createError) {
                  console.error('Error creating default workspace:', createError);
                  setWorkspaces([]);
                }
              }
            } catch (error) {
              console.error('Error loading workspaces:', error);
              setWorkspaces([]);
            }
          };

          const createWorkspace = async () => {
            if (!newWorkspaceName.trim()) return;
            
            try {
              // First create the workspace
              const { data: workspaceData, error: workspaceError } = await supabase
                .from('workspaces')
                .insert([
                  {
                    name: newWorkspaceName.trim(),
                    created_by: user.id
                  }
                ])
                .select()
                .single();

              if (workspaceError) throw workspaceError;

              // Then add the creator to workspace_users (use upsert to avoid duplicates)
              const { error: userError } = await supabase
                .from('workspace_users')
                .upsert([
                  {
                    workspace_id: workspaceData.id,
                    user_id: user.id,
                    role: 'owner'
                  }
                ], {
                  onConflict: 'workspace_id,user_id'
                });

              if (userError) {
                // If adding user fails, clean up the workspace
                await supabase.from('workspaces').delete().eq('id', workspaceData.id);
                throw userError;
              }

              const newWorkspace = {
                id: workspaceData.id,
                name: workspaceData.name
              };
              
              const updatedWorkspaces = [...workspaces, newWorkspace];
              setWorkspaces(updatedWorkspaces);
              
              await switchWorkspace(workspaceData.id);
              
              setNewWorkspaceName('');
              setShowNewWorkspaceForm(false);
            } catch (error) {
              console.error('Error creating workspace:', error);
              alert('×©×’×™××” ×‘×™×¦×™×¨×ª ××¨×—×‘ ×¢×‘×•×“×”: ' + error.message);
            }
          };

          // Initialize workspace data from Supabase
          React.useEffect(() => {
            if (user) {
              loadUserWorkspaces();
            }
          }, [user]);

          // Real-time subscription for projects in current workspace
          React.useEffect(() => {
            if (!currentWorkspace || !user) return;

            const subscription = supabase
              .channel(`projects:workspace_id=eq.${currentWorkspace}`)
              .on('postgres_changes', 
                { 
                  event: '*', 
                  schema: 'public', 
                  table: 'projects',
                  filter: `workspace_id=eq.${currentWorkspace}`
                }, 
                (payload) => {
                  console.log('Real-time update:', payload);
                  
                  switch (payload.eventType) {
                    case 'INSERT':
                      const newProject = {
                        id: payload.new.id,
                        orderDate: payload.new.order_date,
                        clientName: payload.new.client_name,
                        orderDetails: payload.new.order_details,
                        transactionAmount: parseFloat(payload.new.transaction_amount),
                        vatPercent: parseFloat(payload.new.vat_percent),
                        totalPayment: parseFloat(payload.new.total_payment),
                        projectReceipts: parseFloat(payload.new.project_receipts),
                        remainingBalance: parseFloat(payload.new.remaining_balance),
                        projectNotes: payload.new.project_notes || '',
                        invoiceIssued: payload.new.invoice_issued,
                        activationDate: payload.new.activation_date
                      };
                      setProjects(prev => {
                        // Avoid duplicates
                        if (prev.find(p => p.id === newProject.id)) return prev;
                        return [...prev, newProject];
                      });
                      break;
                      
                    case 'UPDATE':
                      const updatedProject = {
                        id: payload.new.id,
                        orderDate: payload.new.order_date,
                        clientName: payload.new.client_name,
                        orderDetails: payload.new.order_details,
                        transactionAmount: parseFloat(payload.new.transaction_amount),
                        vatPercent: parseFloat(payload.new.vat_percent),
                        totalPayment: parseFloat(payload.new.total_payment),
                        projectReceipts: parseFloat(payload.new.project_receipts),
                        remainingBalance: parseFloat(payload.new.remaining_balance),
                        projectNotes: payload.new.project_notes || '',
                        invoiceIssued: payload.new.invoice_issued,
                        activationDate: payload.new.activation_date
                      };
                      setProjects(prev => prev.map(p => 
                        p.id === updatedProject.id ? updatedProject : p
                      ));
                      break;
                      
                    case 'DELETE':
                      setProjects(prev => prev.filter(p => p.id !== payload.old.id));
                      break;
                  }
                }
              )
              .subscribe();

            return () => {
              supabase.removeChannel(subscription);
            };
          }, [currentWorkspace, user]);

          // Monitor online/offline state
          React.useEffect(() => {
            const handleOnline = () => {
              setIsOnline(true);
              console.log('Back online - syncing data...');
              // Reload current workspace data when coming back online
              if (currentWorkspace) {
                loadWorkspaceData(currentWorkspace);
              }
            };
            
            const handleOffline = () => {
              setIsOnline(false);
              console.log('Gone offline - operations will be queued');
            };

            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);

            return () => {
              window.removeEventListener('online', handleOnline);
              window.removeEventListener('offline', handleOffline);
            };
          }, [currentWorkspace]);

          // Note: Direct Supabase operations now handle persistence
          // No need for debounced saving anymore

          const handleAddProject = async () => {
            if (!currentWorkspace) {
              alert('×× × ×‘×—×¨ ××¨×—×‘ ×¢×‘×•×“×”');
              return;
            }

            // Fix: Add validation and safe parsing
            const transactionAmount = parseFloat(newProject.transactionAmount) || 0;
            const vatPercent = parseFloat(newProject.vatPercent) || 17;
            const projectReceipts = parseFloat(newProject.projectReceipts) || 0;
            
            if (!newProject.clientName || !newProject.orderDetails || transactionAmount <= 0) {
              alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
              return;
            }

            const totalPayment = transactionAmount * (1 + vatPercent / 100);
            const remainingBalance = totalPayment - projectReceipts;

            try {
              const { data, error } = await supabase
                .from('projects')
                .insert([
                  {
                    workspace_id: currentWorkspace,
                    order_date: newProject.orderDate,
                    client_name: newProject.clientName,
                    order_details: newProject.orderDetails,
                    transaction_amount: transactionAmount,
                    vat_percent: vatPercent,
                    total_payment: totalPayment,
                    project_receipts: projectReceipts,
                    remaining_balance: remainingBalance,
                    project_notes: newProject.projectNotes || '',
                    invoice_issued: newProject.invoiceIssued || false,
                    activation_date: newProject.activationDate || null
                  }
                ])
                .select()
                .single();

              if (error) throw error;

              // Convert back to application format and add to local state
              const newProjectData = {
                id: data.id,
                orderDate: data.order_date,
                clientName: data.client_name,
                orderDetails: data.order_details,
                transactionAmount: parseFloat(data.transaction_amount),
                vatPercent: parseFloat(data.vat_percent),
                totalPayment: parseFloat(data.total_payment),
                projectReceipts: parseFloat(data.project_receipts),
                remainingBalance: parseFloat(data.remaining_balance),
                projectNotes: data.project_notes || '',
                invoiceIssued: data.invoice_issued,
                activationDate: data.activation_date
              };

              setProjects([...projects, newProjectData]);
              setNewProject({
                orderDate: '',
                clientName: '',
                orderDetails: '',
                transactionAmount: '',
                vatPercent: 17,
                projectReceipts: '',
                projectNotes: '',
                invoiceIssued: false,
                activationDate: ''
              });
              setShowAddForm(false);
            } catch (error) {
              console.error('Error adding project:', error);
              alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×¤×¨×•×™×§×˜');
            }
          };

          const handleEditProject = async (id, updatedProject) => {
            // Fix: Add safe parsing
            const transactionAmount = parseFloat(updatedProject.transactionAmount) || 0;
            const vatPercent = parseFloat(updatedProject.vatPercent) || 17;
            const projectReceipts = parseFloat(updatedProject.projectReceipts) || 0;
            
            const totalPayment = transactionAmount * (1 + vatPercent / 100);
            const remainingBalance = totalPayment - projectReceipts;

            try {
              const { data, error } = await supabase
                .from('projects')
                .update({
                  order_date: updatedProject.orderDate,
                  client_name: updatedProject.clientName,
                  order_details: updatedProject.orderDetails,
                  transaction_amount: transactionAmount,
                  vat_percent: vatPercent,
                  total_payment: totalPayment,
                  project_receipts: projectReceipts,
                  remaining_balance: remainingBalance,
                  project_notes: updatedProject.projectNotes || '',
                  invoice_issued: updatedProject.invoiceIssued || false,
                  activation_date: updatedProject.activationDate || null
                })
                .eq('id', id)
                .select()
                .single();

              if (error) throw error;

              // Update local state with the updated project
              setProjects(projects.map(p => 
                p.id === id 
                  ? { 
                      ...updatedProject, 
                      id, 
                      transactionAmount, 
                      vatPercent, 
                      projectReceipts, 
                      totalPayment, 
                      remainingBalance 
                    }
                  : p
              ));
              setIsEditing(null);
            } catch (error) {
              console.error('Error updating project:', error);
              alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¤×¨×•×™×§×˜');
            }
          };

          const handleDeleteProject = async (id) => {
            try {
              const { error } = await supabase
                .from('projects')
                .delete()
                .eq('id', id);

              if (error) throw error;

              setProjects(projects.filter(p => p.id !== id));
            } catch (error) {
              console.error('Error deleting project:', error);
              alert('×©×’×™××” ×‘××—×™×§×ª ×¤×¨×•×™×§×˜');
            }
          };
          
          // Import projects from JSON file
          const handleImportProjects = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            setIsImporting(true);
            setImportError('');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const importedData = JSON.parse(e.target.result);
                
                // Validate imported data
                if (!Array.isArray(importedData)) {
                  throw new Error('×”×§×•×‘×¥ ×—×™×™×‘ ×œ×”×›×™×œ ××¢×¨×š ×©×œ ×¤×¨×•×™×§×˜×™×');
                }
                
                // Validate each project has required fields
                const validatedProjects = importedData.map((project, index) => {
                  if (!project.clientName || !project.orderDetails || typeof project.transactionAmount !== 'number') {
                    throw new Error(`×¤×¨×•×™×§×˜ ××¡×¤×¨ ${index + 1} ×—×¡×¨ ×©×“×•×ª ×—×•×‘×”`);
                  }
                  
                  // Ensure all numeric fields are properly calculated
                  const transactionAmount = parseFloat(project.transactionAmount) || 0;
                  const vatPercent = parseFloat(project.vatPercent) || 17;
                  const projectReceipts = parseFloat(project.projectReceipts) || 0;
                  const totalPayment = transactionAmount * (1 + vatPercent / 100);
                  const remainingBalance = totalPayment - projectReceipts;
                  
                  return {
                    // Let Supabase auto-generate UUID for id field
                    orderDate: project.orderDate || new Date().toISOString().split('T')[0],
                    clientName: project.clientName,
                    orderDetails: project.orderDetails,
                    transactionAmount,
                    vatPercent,
                    totalPayment,
                    projectReceipts,
                    remainingBalance,
                    projectNotes: project.projectNotes || '',
                    invoiceIssued: typeof project.invoiceIssued === 'boolean' ? project.invoiceIssued : false,
                    activationDate: project.activationDate || null
                  };
                });
                
                // Save validated projects to Supabase
                if (currentWorkspace && validatedProjects.length > 0) {
                  try {
                    // First clear existing projects in this workspace
                    const { error: deleteError } = await supabase
                      .from('projects')
                      .delete()
                      .eq('workspace_id', currentWorkspace);

                    if (deleteError) throw deleteError;

                    // Insert new projects (let Supabase auto-generate UUIDs)
                    const projectsToInsert = validatedProjects.map(project => ({
                      workspace_id: currentWorkspace,
                      order_date: project.orderDate,
                      client_name: project.clientName,
                      order_details: project.orderDetails,
                      transaction_amount: project.transactionAmount,
                      vat_percent: project.vatPercent,
                      total_payment: project.totalPayment,
                      project_receipts: project.projectReceipts,
                      remaining_balance: project.remainingBalance,
                      project_notes: project.projectNotes || '',
                      invoice_issued: project.invoiceIssued,
                      activation_date: project.activationDate
                    }));

                    const { error: insertError } = await supabase
                      .from('projects')
                      .insert(projectsToInsert);

                    if (insertError) throw insertError;

                    // Reload projects from Supabase to get proper IDs
                    await loadWorkspaceData(currentWorkspace);
                    const currentWorkspaceName = workspaces.find(w => w.id === currentWorkspace)?.name || 'workspace';
                    alert(`×™×•×‘××• ×‘×”×¦×œ×—×” ${validatedProjects.length} ×¤×¨×•×™×§×˜×™× ×œ××¨×—×‘ ×”×¢×‘×•×“×” "${currentWorkspaceName}" ×•× ×©××¨×• ×œ××¡×“ ×”× ×ª×•× ×™×`);
                  } catch (supabaseError) {
                    console.error('Error saving imported projects to Supabase:', supabaseError);
                    alert(`×©×’×™××” ×‘×©××™×¨×ª ×”×¤×¨×•×™×§×˜×™× ×œ××¡×“ ×”× ×ª×•× ×™×: ${supabaseError.message}`);
                  }
                } else {
                  // No workspace selected - generate temporary IDs for display
                  const projectsWithTempIds = validatedProjects.map((project, index) => ({
                    ...project,
                    id: `temp_${Date.now()}_${index}`
                  }));
                  setProjects(projectsWithTempIds);
                  alert(`×™×•×‘××• ${validatedProjects.length} ×¤×¨×•×™×§×˜×™× (×œ× × ×©××¨×• ×œ××¡×“ ×”× ×ª×•× ×™× - ××™×Ÿ ××¨×—×‘ ×¢×‘×•×“×” × ×‘×—×¨)`);
                }
                
              } catch (error) {
                setImportError(error.message);
                alert('×©×’×™××” ×‘×™×‘×•× ×”×§×•×‘×¥: ' + error.message);
              } finally {
                setIsImporting(false);
                if (fileInputRef.current) {
                  fileInputRef.current.value = '';
                }
              }
            };
            
            reader.readAsText(file);
          };
          
          // Export projects to JSON file
          const handleExportProjects = () => {
            if (projects.length === 0) {
              alert('××™×Ÿ ×¤×¨×•×™×§×˜×™× ×œ×™×™×¦×•×');
              return;
            }
            
            const dataStr = JSON.stringify(projects, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            const currentWorkspaceName = workspaces.find(w => w.id === currentWorkspace)?.name || 'workspace';
            const today = new Date().toISOString().split('T')[0];
            link.download = `${currentWorkspaceName.replace(/[^a-zA-Z0-9\u0590-\u05FF]/g, '-')}-${today}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
          };
          
          // Clear all projects (start fresh)
          const handleClearDatabase = async () => {
            if (projects.length === 0) {
              alert('×”××¡×“ × ×ª×•× ×™× ×›×‘×¨ ×¨×™×§');
              return;
            }
            
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×¤×¨×•×™×§×˜×™×? ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) {
              try {
                const { error } = await supabase
                  .from('projects')
                  .delete()
                  .eq('workspace_id', currentWorkspace);

                if (error) throw error;

                setProjects([]);
                alert('××¡×“ ×”× ×ª×•× ×™× × ××—×§ ×‘×”×¦×œ×—×”');
              } catch (error) {
                console.error('Error clearing database:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ××¡×“ ×”× ×ª×•× ×™×');
              }
            }
          };

          const filteredProjectsForTable = projects.filter(project =>
            project.clientName.toLowerCase().includes(searchTerm.toLowerCase()) ||
            project.orderDetails.toLowerCase().includes(searchTerm.toLowerCase())
          );

          const formatCurrency = (amount) => {
            return new Intl.NumberFormat('he-IL', {
              style: 'currency',
              currency: 'ILS',
              currencyDisplay: 'symbol'
            }).format(amount).replace('IL', '');
          };

          const formatDateHebrew = (date) => {
            if (!date) return '×œ× ×”×•×’×“×¨';
            const d = new Date(date);
            if (isNaN(d.getTime())) return '×ª××¨×™×š ×œ× ×ª×§×™×Ÿ';
            return d.toLocaleDateString('he-IL', {
              day: '2-digit',
              month: '2-digit',
              year: '2-digit'
            });
          };

          const KPICard = ({ title, value, iconName, color, subtitle }) => (
            React.createElement('div', {
              className: "bg-white rounded-lg shadow-lg p-6 border-r-4",
              style: { borderColor: color }
            },
              React.createElement('div', { className: "flex items-center justify-between" },
                React.createElement('div', null,
                  React.createElement('p', { className: "text-gray-600 text-sm font-medium" }, title),
                  React.createElement('p', { className: "text-2xl font-bold text-gray-900" }, value),
                  subtitle && React.createElement('p', { className: "text-sm text-gray-500 mt-1" }, subtitle)
                ),
                React.createElement(Icon, { name: iconName, className: "h-8 w-8", style: { color } })
              )
            )
          );

          const ProjectRow = ({ project, isEditing, onEdit, onSave, onCancel, onDelete, formatCurrency }) => {
            const [editData, setEditData] = useState(project);

            const handleSave = () => {
              onSave(editData);
            };

            if (isEditing) {
              return React.createElement('tr', { className: "bg-yellow-50" },
                React.createElement('td', { className: "px-6 py-4" },
                  React.createElement('input', {
                    type: "date",
                    value: editData.orderDate,
                    onChange: (e) => setEditData({...editData, orderDate: e.target.value}),
                    className: "w-full border border-gray-300 rounded px-2 py-1"
                  })
                ),
                React.createElement('td', { className: "px-6 py-4" },
                  React.createElement('input', {
                    type: "text",
                    value: editData.clientName,
                    onChange: (e) => setEditData({...editData, clientName: e.target.value}),
                    className: "w-full border border-gray-300 rounded px-2 py-1 text-right"
                  })
                ),
                React.createElement('td', { className: "px-6 py-4" },
                  React.createElement('input', {
                    type: "text",
                    value: editData.orderDetails,
                    onChange: (e) => setEditData({...editData, orderDetails: e.target.value}),
                    className: "w-full border border-gray-300 rounded px-2 py-1 text-right"
                  })
                ),
                React.createElement('td', { className: "px-6 py-4" },
                  React.createElement('input', {
                    type: "number",
                    value: editData.transactionAmount,
                    onChange: (e) => setEditData({...editData, transactionAmount: e.target.value}),
                    className: "w-full border border-gray-300 rounded px-2 py-1"
                  })
                ),
                React.createElement('td', { className: "px-6 py-4" },
                  React.createElement('input', {
                    type: "number",
                    value: editData.vatPercent,
                    onChange: (e) => setEditData({...editData, vatPercent: e.target.value}),
                    className: "w-full border border-gray-300 rounded px-2 py-1"
                  })
                ),
                React.createElement('td', { className: "px-6 py-4 text-sm text-gray-900" },
                  formatCurrency((parseFloat(editData.transactionAmount) || 0) * (1 + (parseFloat(editData.vatPercent) || 17) / 100))
                ),
                React.createElement('td', { className: "px-6 py-4" },
                  React.createElement('input', {
                    type: "number",
                    value: editData.projectReceipts,
                    onChange: (e) => setEditData({...editData, projectReceipts: e.target.value}),
                    className: "w-full border border-gray-300 rounded px-2 py-1"
                  })
                ),
                React.createElement('td', { className: "px-6 py-4 text-sm text-gray-900" },
                  formatCurrency(((parseFloat(editData.transactionAmount) || 0) * (1 + (parseFloat(editData.vatPercent) || 17) / 100)) - (parseFloat(editData.projectReceipts) || 0))
                ),
                React.createElement('td', { className: "px-6 py-4" },
                  React.createElement('input', {
                    type: "text",
                    value: editData.projectNotes,
                    onChange: (e) => setEditData({...editData, projectNotes: e.target.value}),
                    className: "w-full border border-gray-300 rounded px-2 py-1 text-right"
                  })
                ),
                React.createElement('td', { className: "px-6 py-4 text-center" },
                  React.createElement('input', {
                    type: "date",
                    value: editData.activationDate || '',
                    onChange: (e) => setEditData({...editData, activationDate: e.target.value}),
                    className: "w-full border border-gray-300 rounded px-2 py-1"
                  })
                ),
                React.createElement('td', { className: "px-6 py-4 text-center" },
                  React.createElement('input', {
                    type: "checkbox",
                    checked: editData.invoiceIssued || false,
                    onChange: (e) => setEditData({...editData, invoiceIssued: e.target.checked}),
                    className: "rounded border-gray-300"
                  })
                ),
                React.createElement('td', { className: "px-6 py-4" },
                  React.createElement('div', { className: "flex space-x-reverse space-x-2" },
                    React.createElement('button', {
                      onClick: handleSave,
                      className: "text-green-600 hover:text-green-900"
                    }, React.createElement(Icon, { name: "save", className: "h-4 w-4" })),
                    React.createElement('button', {
                      onClick: onCancel,
                      className: "text-gray-600 hover:text-gray-900"
                    }, React.createElement(Icon, { name: "x", className: "h-4 w-4" }))
                  )
                )
              );
            }

            return React.createElement('tr', { className: "hover:bg-gray-50" },
              React.createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900" }, project.orderDate),
              React.createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right" }, project.clientName),
              React.createElement('td', { className: "px-6 py-4 text-sm text-gray-900 text-right max-w-xs truncate" }, project.orderDetails),
              React.createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900" }, formatCurrency(project.transactionAmount)),
              React.createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900" }, project.vatPercent + '%'),
              React.createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium" }, formatCurrency(project.totalPayment)),
              React.createElement('td', { className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900" }, formatCurrency(project.projectReceipts)),
              React.createElement('td', { 
                className: `px-6 py-4 whitespace-nowrap text-sm font-medium ${project.remainingBalance === 0 ? 'text-green-600' : 'text-red-600'}`
              }, formatCurrency(project.remainingBalance)),
              React.createElement('td', { className: "px-6 py-4 text-sm text-gray-900 text-right max-w-xs truncate" }, project.projectNotes),
              React.createElement('td', { className: "px-6 py-4 text-center text-sm text-gray-900" }, 
                project.activationDate ? formatDateHebrew(project.activationDate) : '×œ× ×”×•×’×“×¨'
              ),
              React.createElement('td', { className: "px-6 py-4 text-center" },
                React.createElement('input', {
                  type: "checkbox",
                  checked: project.invoiceIssued || false,
                  readOnly: true,
                  className: "rounded border-gray-300"
                })
              ),
              React.createElement('td', { className: "px-6 py-4 whitespace-nowrap" },
                React.createElement('div', { className: "flex space-x-reverse space-x-2" },
                  React.createElement('button', {
                    onClick: onEdit,
                    className: "text-blue-600 hover:text-blue-900"
                  }, React.createElement(Icon, { name: "edit-2", className: "h-4 w-4" })),
                  React.createElement('button', {
                    onClick: onDelete,
                    className: "text-red-600 hover:text-red-900"
                  }, React.createElement(Icon, { name: "trash-2", className: "h-4 w-4" }))
                )
              )
            );
          };

          return React.createElement('div', { className: "min-h-screen bg-gray-50", dir: "rtl" },
            // Header
            React.createElement('div', { className: "bg-white shadow-sm border-b" },
              React.createElement('div', { className: "max-w-7xl mx-auto px-4" },
                React.createElement('div', { className: "flex justify-between items-center py-4" },
                  React.createElement('div', { className: "flex items-center space-x-reverse space-x-4" },
                    React.createElement('h1', { className: "text-2xl font-bold text-gray-900" }, '×“×©×‘×•×¨×“ ×¤×™× × ×¡×™ ×—×›×'),
                    
                    // Workspace Selector
                    React.createElement('div', { className: "flex items-center space-x-reverse space-x-3 bg-gray-50 rounded-lg p-2" },
                      React.createElement(Icon, { name: 'database', className: "h-5 w-5 text-gray-600" }),
                      React.createElement('select', {
                        value: currentWorkspace || '',
                        onChange: (e) => switchWorkspace(e.target.value),
                        className: "bg-transparent border-none outline-none text-sm font-medium text-gray-700 cursor-pointer"
                      }, 
                        !currentWorkspace && React.createElement('option', { value: '', disabled: true }, '×˜×•×¢×Ÿ ××¨×—×‘×™ ×¢×‘×•×“×”...'),
                        workspaces.map(workspace => 
                          React.createElement('option', { key: workspace.id, value: workspace.id }, workspace.name)
                        )
                      ),
                      React.createElement('button', {
                        onClick: () => setShowNewWorkspaceForm(true),
                        className: "text-blue-600 hover:text-blue-700 text-sm font-medium",
                        title: "×”×•×¡×£ ××¨×—×‘ ×¢×‘×•×“×” ×—×“×©"
                      }, React.createElement(Icon, { name: 'plus', className: "h-4 w-4" }))
                    )
                  ),
                  
                  React.createElement('div', { className: "flex items-center space-x-reverse space-x-4" },
                    React.createElement('div', {
                      className: `flex items-center space-x-reverse space-x-2 px-2 py-1 rounded-lg text-xs ${
                        isOnline 
                          ? 'bg-green-100 text-green-800' 
                          : 'bg-red-100 text-red-800'
                      }`,
                      title: isOnline ? '××—×•×‘×¨ ×œ×¨×©×ª' : '×œ× ××—×•×‘×¨ ×œ×¨×©×ª'
                    }, [
                      React.createElement('div', {
                        className: `w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`,
                        key: "status-dot"
                      }),
                      React.createElement('span', {
                        key: "status-text"
                      }, isOnline ? '××—×•×‘×¨' : '×œ× ××—×•×‘×¨')
                    ]),
                    
                    React.createElement('button', {
                      onClick: async () => {
                        const { error } = await supabase.auth.signOut();
                        if (error) console.error('Error logging out:', error);
                      },
                      className: "px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50",
                      title: "×”×ª× ×ª×§"
                    }, '×”×ª× ×ª×§'),
                    
                    React.createElement('button', {
                      onClick: () => setActiveTab('dashboard'),
                      className: `px-4 py-2 rounded-lg font-medium ${
                        activeTab === 'dashboard' 
                          ? 'bg-blue-600 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`
                    }, '×“×©×‘×•×¨×“'),
                    React.createElement('button', {
                      onClick: () => setActiveTab('database'),
                      className: `px-4 py-2 rounded-lg font-medium ${
                        activeTab === 'database' 
                          ? 'bg-blue-600 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`
                    }, '××¡×“ × ×ª×•× ×™×')
                  )
                )
              )
            ),

            // New Workspace Form Modal
            showNewWorkspaceForm && React.createElement('div', { 
              className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
            },
              React.createElement('div', { className: "bg-white rounded-lg p-6 w-96 max-w-md mx-4" },
                React.createElement('h3', { className: "text-lg font-semibold text-gray-900 mb-4" }, '×”×•×¡×£ ××¨×—×‘ ×¢×‘×•×“×” ×—×“×©'),
                React.createElement('input', {
                  type: "text",
                  placeholder: "×©× ××¨×—×‘ ×”×¢×‘×•×“×”",
                  value: newWorkspaceName,
                  onChange: (e) => setNewWorkspaceName(e.target.value),
                  className: "w-full border border-gray-300 rounded-md px-3 py-2 text-right mb-4",
                  onKeyPress: (e) => e.key === 'Enter' && createWorkspace()
                }),
                React.createElement('div', { className: "flex justify-end space-x-reverse space-x-4" },
                  React.createElement('button', {
                    onClick: () => {
                      setShowNewWorkspaceForm(false);
                      setNewWorkspaceName('');
                    },
                    className: "px-4 py-2 text-gray-600 hover:text-gray-800"
                  }, '×‘×™×˜×•×œ'),
                  React.createElement('button', {
                    onClick: createWorkspace,
                    className: "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                  }, '×™×¦×™×¨×”')
                )
              )
            ),

            React.createElement('div', { className: "max-w-7xl mx-auto px-4 py-6" },
              activeTab === 'dashboard' && React.createElement('div', { className: "space-y-6" },
                // Project Filter
                React.createElement('div', { className: "bg-white rounded-lg shadow p-4" },
                  React.createElement('div', { className: "flex items-center space-x-reverse space-x-4" },
                    React.createElement(Icon, { name: "filter", className: "h-5 w-5 text-gray-500" }),
                    React.createElement('label', { className: "text-sm font-medium text-gray-700" }, '×¡×™× ×•×Ÿ ×œ×¤×™ ×¤×¨×•×™×§×˜:'),
                    React.createElement('select', {
                      value: selectedProject,
                      onChange: (e) => setSelectedProject(e.target.value),
                      className: "border border-gray-300 rounded-md px-3 py-2 bg-white text-right"
                    },
                      React.createElement('option', { value: "all" }, '×›×œ ×”×¤×¨×•×™×§×˜×™×'),
                      projects.map(project => 
                        React.createElement('option', { key: project.id, value: project.id },
                          project.clientName + ' - ' + project.orderDetails.substring(0, 30) + '...'
                        )
                      )
                    )
                  )
                ),

                // KPI Cards
                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" },
                  React.createElement(KPICard, {
                    title: "×¡×›×•× ×¢×¡×§××•×ª",
                    value: formatCurrency(dashboardData.totalTransactionAmount),
                    iconName: "dollar-sign",
                    color: "#3B82F6"
                  }),
                  React.createElement(KPICard, {
                    title: "×¡×›×•× ××¢×´×",
                    value: formatCurrency(dashboardData.totalVatAmount),
                    iconName: "receipt",
                    color: "#10B981"
                  }),
                  React.createElement(KPICard, {
                    title: "×¡×”×´×› ×œ×ª×©×œ×•×",
                    value: formatCurrency(dashboardData.totalPayment),
                    iconName: "trending-up",
                    color: "#8B5CF6"
                  }),
                  React.createElement(KPICard, {
                    title: "×ª×§×‘×•×œ×™× ×œ×¤×¨×•×™×§×˜",
                    value: formatCurrency(dashboardData.totalReceipts),
                    iconName: "check-circle",
                    color: "#06B6D4"
                  }),
                  React.createElement(KPICard, {
                    title: "×™×ª×¨×” ×œ×ª×©×œ×•×",
                    value: formatCurrency(dashboardData.totalRemaining),
                    iconName: "alert-circle",
                    color: "#EF4444"
                  }),
                  React.createElement(KPICard, {
                    title: "××—×•×– ×”×©×œ××”",
                    value: `${dashboardData.completionRate.toFixed(1)}%`,
                    iconName: "trending-up",
                    color: "#F59E0B",
                    subtitle: `${dashboardData.completedProjects} ××ª×•×š ${dashboardData.totalProjects} ×¤×¨×•×™×§×˜×™×`
                  }),
                  React.createElement(KPICard, {
                    title: "×—×©×‘×•× ×™×•×ª ×”×•× ×¤×§×•",
                    value: `${dashboardData.invoiceRate.toFixed(1)}%`,
                    iconName: "receipt",
                    color: "#059669",
                    subtitle: `${dashboardData.invoicedProjects} ××ª×•×š ${dashboardData.totalProjects} ×¤×¨×•×™×§×˜×™×`
                  }),
                  React.createElement(KPICard, {
                    title: "×ª××¨×™×š ×”×¤×¢×œ×” ××—×¨×•×Ÿ",
                    value: dashboardData.latestActivationDate ? formatDateHebrew(dashboardData.latestActivationDate) : '××™×Ÿ × ×ª×•× ×™×',
                    iconName: "trending-up",
                    color: "#7C3AED",
                    subtitle: `${dashboardData.projectsWithActivation} ××ª×•×š ${dashboardData.totalProjects} ×¤×¨×•×™×§×˜×™×`
                  })
                ),

                // Project Status Overview
                React.createElement('div', { className: "bg-white rounded-lg shadow p-6" },
                  React.createElement('h3', { className: "text-lg font-semibold text-gray-900 mb-4" }, '×¡×˜×˜×•×¡ ×¤×¨×•×™×§×˜×™×'),
                  React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4" },
                    React.createElement('div', { className: "text-center p-4 bg-green-50 rounded-lg" },
                      React.createElement('div', { className: "text-2xl font-bold text-green-600" }, dashboardData.completedProjects),
                      React.createElement('div', { className: "text-sm text-green-800" }, '×¤×¨×•×™×§×˜×™× ×©×”×•×©×œ××•')
                    ),
                    React.createElement('div', { className: "text-center p-4 bg-yellow-50 rounded-lg" },
                      React.createElement('div', { className: "text-2xl font-bold text-yellow-600" }, dashboardData.inProgressProjects),
                      React.createElement('div', { className: "text-sm text-yellow-800" }, '×¤×¨×•×™×§×˜×™× ×‘×ª×”×œ×™×š')
                    ),
                    React.createElement('div', { className: "text-center p-4 bg-blue-50 rounded-lg" },
                      React.createElement('div', { className: "text-2xl font-bold text-blue-600" }, dashboardData.totalProjects),
                      React.createElement('div', { className: "text-sm text-blue-800" }, '×¡×”×´×› ×¤×¨×•×™×§×˜×™×')
                    )
                  )
                )
              ),

              activeTab === 'database' && React.createElement('div', { className: "space-y-6" },
                // Search, Import, Export, and Add
                React.createElement('div', { className: "bg-white rounded-lg shadow p-4" },
                  React.createElement('div', { className: "flex justify-between items-center mb-4" },
                    React.createElement('div', { className: "flex items-center space-x-reverse space-x-4" },
                      React.createElement(Icon, { name: "search", className: "h-5 w-5 text-gray-500" }),
                      React.createElement('input', {
                        type: "text",
                        placeholder: "×—×™×¤×•×© ×œ×¤×™ ×©× ×œ×§×•×— ××• ×¤×™×¨×•×˜ ×”×–×× ×”...",
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: "border border-gray-300 rounded-md px-3 py-2 w-80 text-right"
                      })
                    ),
                    React.createElement('div', { className: "flex items-center space-x-reverse space-x-2" },
                      // Import button
                      React.createElement('button', {
                        onClick: () => fileInputRef.current.click(),
                        disabled: isImporting,
                        className: "bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-reverse space-x-2 disabled:opacity-50"
                      },
                        React.createElement(Icon, { name: "upload", className: "h-4 w-4" }),
                        React.createElement('span', null, isImporting ? '××™×™×‘×...' : '×™×‘×•× ××§×•×‘×¥')
                      ),
                      // Export button
                      React.createElement('button', {
                        onClick: handleExportProjects,
                        disabled: projects.length === 0,
                        className: "bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center space-x-reverse space-x-2 disabled:opacity-50"
                      },
                        React.createElement(Icon, { name: "download", className: "h-4 w-4" }),
                        React.createElement('span', null, '×™×™×¦×•× ×œ×§×•×‘×¥')
                      ),
                      // Clear database button
                      React.createElement('button', {
                        onClick: handleClearDatabase,
                        disabled: projects.length === 0,
                        className: "bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center space-x-reverse space-x-2 disabled:opacity-50"
                      },
                        React.createElement(Icon, { name: "trash-2", className: "h-4 w-4" }),
                        React.createElement('span', null, '××—×§ ×”×›×œ')
                      ),
                      // Add project button
                      React.createElement('button', {
                        onClick: () => setShowAddForm(true),
                        className: "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-reverse space-x-2"
                      },
                        React.createElement(Icon, { name: "plus", className: "h-4 w-4" }),
                        React.createElement('span', null, '×”×•×¡×£ ×¤×¨×•×™×§×˜')
                      )
                    )
                  ),
                  // Hidden file input for import
                  React.createElement('input', {
                    type: "file",
                    ref: fileInputRef,
                    accept: ".json",
                    onChange: handleImportProjects,
                    style: { display: 'none' }
                  })
                ),

                // Add Project Form
                showAddForm && React.createElement('div', { className: "bg-white rounded-lg shadow p-6" },
                  React.createElement('h3', { className: "text-lg font-semibold text-gray-900 mb-4" }, '×”×•×¡×£ ×¤×¨×•×™×§×˜ ×—×“×©'),
                  React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" },
                    React.createElement('input', {
                      type: "date",
                      placeholder: "×ª××¨×™×š ×”×–×× ×”",
                      value: newProject.orderDate,
                      onChange: (e) => setNewProject({...newProject, orderDate: e.target.value}),
                      className: "border border-gray-300 rounded-md px-3 py-2"
                    }),
                    React.createElement('input', {
                      type: "text",
                      placeholder: "×©× ×œ×§×•×—",
                      value: newProject.clientName,
                      onChange: (e) => setNewProject({...newProject, clientName: e.target.value}),
                      className: "border border-gray-300 rounded-md px-3 py-2 text-right"
                    }),
                    React.createElement('input', {
                      type: "text",
                      placeholder: "×¤×™×¨×•×˜ ×”×–×× ×”",
                      value: newProject.orderDetails,
                      onChange: (e) => setNewProject({...newProject, orderDetails: e.target.value}),
                      className: "border border-gray-300 rounded-md px-3 py-2 text-right"
                    }),
                    React.createElement('input', {
                      type: "number",
                      placeholder: "×¡×›×•× ×¢×¡×§×”",
                      value: newProject.transactionAmount,
                      onChange: (e) => setNewProject({...newProject, transactionAmount: e.target.value}),
                      className: "border border-gray-300 rounded-md px-3 py-2"
                    }),
                    React.createElement('input', {
                      type: "number",
                      placeholder: "××¢×´× (%)",
                      value: newProject.vatPercent,
                      onChange: (e) => setNewProject({...newProject, vatPercent: e.target.value}),
                      className: "border border-gray-300 rounded-md px-3 py-2"
                    }),
                    React.createElement('input', {
                      type: "number",
                      placeholder: "×ª×§×‘×•×œ×™× ×œ×¤×¨×•×™×§×˜",
                      value: newProject.projectReceipts,
                      onChange: (e) => setNewProject({...newProject, projectReceipts: e.target.value}),
                      className: "border border-gray-300 rounded-md px-3 py-2"
                    }),
                    React.createElement('input', {
                      type: "text",
                      placeholder: "×”×¢×¨×•×ª ×œ×¤×¨×•×™×§×˜",
                      value: newProject.projectNotes,
                      onChange: (e) => setNewProject({...newProject, projectNotes: e.target.value}),
                      className: "border border-gray-300 rounded-md px-3 py-2 text-right md:col-span-2"
                    }),
                    React.createElement('div', { className: "flex items-center space-x-reverse space-x-2" },
                      React.createElement('input', {
                        type: "checkbox",
                        id: "invoiceIssued",
                        checked: newProject.invoiceIssued,
                        onChange: (e) => setNewProject({...newProject, invoiceIssued: e.target.checked}),
                        className: "rounded border-gray-300"
                      }),
                      React.createElement('label', { htmlFor: "invoiceIssued", className: "text-sm font-medium text-gray-700" }, '×—×©×‘×•× ×™×ª ×”×•× ×¤×§×”')
                    ),
                    React.createElement('input', {
                      type: "date",
                      placeholder: "×ª××¨×™×š ×”×¤×¢×œ×”",
                      value: newProject.activationDate,
                      onChange: (e) => setNewProject({...newProject, activationDate: e.target.value}),
                      className: "border border-gray-300 rounded-md px-3 py-2"
                    })
                  ),
                  React.createElement('div', { className: "flex justify-end space-x-reverse space-x-4 mt-4" },
                    React.createElement('button', {
                      onClick: () => setShowAddForm(false),
                      className: "px-4 py-2 text-gray-600 hover:text-gray-800"
                    }, '×‘×™×˜×•×œ'),
                    React.createElement('button', {
                      onClick: handleAddProject,
                      className: "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                    }, '×©××•×¨')
                  )
                ),

                // Empty state or Projects Table
                projects.length === 0 ? 
                  React.createElement('div', { className: "bg-white rounded-lg shadow p-12 text-center" },
                    React.createElement(Icon, { name: "database", className: "h-16 w-16 text-gray-400 mx-auto mb-4" }),
                    React.createElement('h3', { className: "text-lg font-semibold text-gray-900 mb-2" }, '××¡×“ × ×ª×•× ×™× ×¨×™×§'),
                    React.createElement('p', { className: "text-gray-600 mb-6" }, '×™×‘× ××ª ××¡×“ ×”× ×ª×•× ×™× ×©×œ×š ××§×•×‘×¥ JSON ××• ×”×ª×—×œ ×œ×™×¦×•×¨ ×¤×¨×•×™×§×˜×™× ×—×“×©×™×'),
                    React.createElement('div', { className: "flex justify-center space-x-reverse space-x-4" },
                      React.createElement('button', {
                        onClick: () => fileInputRef.current.click(),
                        className: "bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 flex items-center space-x-reverse space-x-2"
                      },
                        React.createElement(Icon, { name: "upload", className: "h-5 w-5" }),
                        React.createElement('span', null, '×™×‘×•× ××¡×“ × ×ª×•× ×™×')
                      ),
                      React.createElement('button', {
                        onClick: () => setShowAddForm(true),
                        className: "bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center space-x-reverse space-x-2"
                      },
                        React.createElement(Icon, { name: "plus", className: "h-5 w-5" }),
                        React.createElement('span', null, '×¦×•×¨ ×¤×¨×•×™×§×˜ ×—×“×©')
                      )
                    )
                  ) :
                  // Projects Table
                  React.createElement('div', { className: "bg-white rounded-lg shadow overflow-hidden" },
                  React.createElement('div', { className: "overflow-x-auto" },
                    React.createElement('table', { className: "min-w-full divide-y divide-gray-200" },
                      React.createElement('thead', { className: "bg-gray-50" },
                        React.createElement('tr', null,
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×ª××¨×™×š ×”×–×× ×”'),
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×©× ×œ×§×•×—'),
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×¤×™×¨×•×˜ ×”×–×× ×”'),
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×¡×›×•× ×¢×¡×§×”'),
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '××¢×´× (%)'),
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×¡×”×´×› ×œ×ª×©×œ×•×'),
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×ª×§×‘×•×œ×™×'),
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×™×ª×¨×”'),
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×”×¢×¨×•×ª'),
                          React.createElement('th', { className: "px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×ª××¨×™×š ×”×¤×¢×œ×”'),
                          React.createElement('th', { className: "px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×—×©×‘×•× ×™×ª'),
                          React.createElement('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" }, '×¤×¢×•×œ×•×ª')
                        )
                      ),
                      React.createElement('tbody', { className: "bg-white divide-y divide-gray-200" },
                        filteredProjectsForTable.map((project) => 
                          React.createElement(ProjectRow, {
                            key: project.id,
                            project: project,
                            isEditing: isEditing === project.id,
                            onEdit: () => setIsEditing(project.id),
                            onSave: (updatedProject) => handleEditProject(project.id, updatedProject),
                            onCancel: () => setIsEditing(null),
                            onDelete: () => handleDeleteProject(project.id),
                            formatCurrency: formatCurrency
                          })
                        )
                      )
                    )
                  )
                )
              )
            )
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(ErrorBoundary, null, React.createElement(App)));
    </script>
</body>
</html>